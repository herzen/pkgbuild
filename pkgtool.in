#!/bin/bash
#
#  The pkgbuild build engine
#
#  Copyright (C) 2004, 2005 Sun Microsystems, Inc.
#
#  pkgbuild is free software; you can redistribute it and/or
#  modify it under the terms of the GNU General Public License 
#  version 2 published by the Free Software Foundation.
#
#  pkgbuild is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
#  General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program; if not, write to the Free Software
#  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
#
#  As a special exception to the GNU General Public License, if you
#  distribute this file as part of a program that contains a
#  configuration script generated by Autoconf, you may include it under
#  the same distribution terms that you use for the rest of that program.
#
#  Authors:  Laszlo Peter  <laca@sun.com>
#

origwd=`pwd`;
mydir=$(cd $(dirname $0); pwd);

/usr/bin/id | /usr/bin/grep '^uid=0(' > /dev/null 2>&1
is_root=$?

if [ `uname -s` = "SunOS" ]; then
    profiles | fgrep -sx "Software Installation" > /dev/null 2>&1
    haveinstallprofile=$?

    if [ $is_root != 0 -a $haveinstallprofile != 0 ]; then
	echo "Run this script as root or make sure you have been assigned"
	echo "the 'Software Installation' profile"
	echo "See the user_attr(4) and profiles(1) man pages for more details"
	exit 1
    fi
else
    :
#    if [ $is_root != 0 ]; then
#	echo "Run this script as root"
#    fi
fi

pkgbuild_prefix=
IFS=:
for dir in $PATH; do
    if [ -x $dir/pkgbuild ]; then
        pkgbuild_prefix=$(cd $dir/../; pwd)
	break;
    fi
done

if [ -z "$pkgbuild_prefix" ]; then
    pkgbuild_libdir="@PKGBUILD_LIBDIR@"
    pkgbuild_prefix="$pkgbuild_libdir/../.."
    echo "ERROR: pkgbuild not found in the PATH" 1>&2
    exit 1
else
    pkgbuild_version=`"$pkgbuild_prefix/bin/pkgbuild" --version | \
    grep '^pkgbuild version' | cut -f3 -d' '`
    pkgbuild_libdir="$pkgbuild_prefix/lib/pkgbuild-$pkgbuild_version"
fi

exec perl -I "$pkgbuild_libdir" $pkgbuild_libdir/pkgtool.pl "${@}"
